# Исправления для развертывания сайта "Вести Ингушетии"

## Проблемы и решения

### 1. Ошибка PostgreSQL "could not write init file"

**Причина:** Недостаточно места на диске, проблемы с правами доступа или повреждение файловой системы.

**Решение:**
1. Проверьте место на диске: `df -h`
2. Проверьте логи PostgreSQL: `sudo tail -f /var/log/postgresql/postgresql-*.log`
3. Проверьте права доступа к директории данных PostgreSQL
4. Перезапустите PostgreSQL: `sudo systemctl restart postgresql`

**Диагностика:**
```bash
cd client/server
node test-postgres.js
```

### 2. Вредоносный код в файлах

**Причина:** Файлы содержат ASP/JSP теги, которые система безопасности распознает как вредоносный код.

**Решение:**
- Система автоматически удаляет подозрительные файлы
- Улучшена валидация при загрузке файлов
- Добавлена проверка на паттерны `/<%/i`

### 3. CORS блокировки

**Причина:** Запросы с внешних доменов блокируются CORS политикой.

**Решение:**
- Добавлены разрешенные домены для интеграций:
  - ya.ru, yandex.ru (Яндекс)
  - powerpoint.officeapps.live.com (Microsoft Office)
  - rutube.ru, player.smotrim.ru (видео сервисы)

### 4. "Сиротские" медиа-файлы

**Причина:** Записи в БД ссылаются на файлы, которые уже удалены с диска.

**Решение:**
- Изменены логи предупреждений (теперь информационные сообщения)
- Создан скрипт очистки сиротских записей:

```bash
cd client/server
node cleanup-orphaned-media.js
```

## Изменения в коде

### Конфигурация базы данных (`client/server/config/config.js`)
- Добавлены таймауты подключения
- Увеличены размеры пула соединений
- Добавлена retry логика

### Сервер (`client/server/server.js`)
- Добавлена retry логика при подключении к БД
- Обновлена CORS политика
- Лучшая обработка ошибок

### Контроллер новостей (`client/server/controllers/news.controller.js`)
- Исправлены логи предупреждений для несуществующих файлов

### Система безопасности (`client/server/middlewares/uploads.middleware.js`)
- Улучшена проверка содержимого файлов

## Мониторинг и поддержка

### Логи для мониторинга:
- `[SECURITY]` - проблемы безопасности
- `[DELETE]` - операции удаления файлов
- `ℹ️` - информационные сообщения
- `✅` - успешные операции
- `❌` - ошибки

### Диагностические скрипты:
- `test-postgres.js` - проверка подключения к БД
- `cleanup-orphaned-media.js` - очистка сиротских записей

## Профилактика

1. **Регулярно проверяйте место на диске**
2. **Мониторьте логи на предмет ошибок безопасности**
3. **Регулярно запускайте очистку сиротских записей**
4. **Следите за обновлениями зависимостей**

## Контакты

При возникновении проблем обращайтесь к разработчикам или системному администратору.
